{
	"steps": [
		{
			"title": "Etape 1",
			"description": "Première étape de la validation.\nLes filtres appliqués montrent uniquement les variants dont la fréquence allélique en population générale est inférieure à 1%.",
			"query": {
				"select": {
					"fields": [
						"main_table.run_name",
						"main_table.sample_name",
						"main_table.snpeff_Gene_Name",
						"main_table.snpeff_Feature_ID",
						"main_table.chromosome",
						"main_table.position",
						"main_table.reference",
						"main_table.alternate",
						"main_table.cv_AF",
						"main_table.snpeff_Annotation",
						"main_table.cv_GT",
						"main_table.snpeff_Annotation_Impact",
						"agg.ref_count",
						"agg.var_count",
						"recur.count"
					],
					"tables": [
						{
							"expression": "{main_table}",
							"alias": "main_table"
						},
						{
							"expression": "read_parquet('{pwd}/aggregates/variants.parquet')",
							"alias": "agg",
							"on": "main_table.variant_hash = agg.variant_hash",
							"how": ""
						},
						{
							"select": {
								"fields": [
									"variant_hash",
									"COUNT(*) as count"
								],
								"tables": [
									{
										"select": {
											"fields": [
												"DISTINCT(sample_name)",
												"variant_hash"
											],
											"tables": [
												{
													"expression": "{main_table}",
													"alias": ""
												}
											]
										},
										"alias": ""
									}
								],
								"group_by": [
									"variant_hash"
								]
							},
							"alias": "recur",
							"on": "main_table.variant_hash = recur.variant_hash",
							"how": ""
						}
					],
					"filter": {
						"filter_type": "AND",
						"children": [
							{
								"expression": "main_table.cv_GT = 1",
								"children": []
							},
							{
								"expression": "main_table.snpeff_Gene_Name IN ('CFTR','COPA')",
								"children": []
							}
						]
					},
					"order_by": [
						{
							"field": "main_table.chromosome",
							"order": "ASC"
						},
						{
							"field": "main_table.position",
							"order": "ASC"
						}
					]
				}
			}
		}
	],
	"final": {
		"query": {
			"select": {
				"fields": [
					"'hg19' AS reference_genome",
					"main_table.run_name",
					"main_table.chromosome",
					"main_table.position",
					"main_table.reference",
					"main_table.alternate",
					"main_table.snpeff_Annotation_Impact",
					"main_table.snpeff_Gene_Name",
					"main_table.snpeff_Gene_ID",
					"main_table.snpeff_Feature_Type",
					"main_table.snpeff_Feature_ID",
					"agg.ref_count",
					"agg.var_count",
					"user_table.validation_hash"
				],
				"tables": [
					{
						"expression": "{main_table}",
						"alias": "main_table"
					},
					{
						"expression": "'{pwd}/aggregates/variants.parquet'",
						"alias": "agg",
						"on": "main_table.variant_hash = agg.variant_hash",
						"how": ""
					},
					{
						"expression": "{user_table}",
						"alias": "user_table",
						"on": "main_table.validation_hash = user_table.validation_hash",
						"how": ""
					}
				]
			}
		}
	}
}